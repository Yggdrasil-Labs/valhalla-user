name: Release Please

on:
  push:
    branches: [ main ]
  pull_request:
    types: [opened, synchronize, closed]
    branches: [ main ]
  workflow_dispatch: {}

permissions:
  contents: write
  pull-requests: write

jobs:
  release-please:
    runs-on: ubuntu-latest
    # é¿å…é‡å¤æ‰§è¡Œï¼š
    # - å½“ PR åˆå¹¶æ—¶ï¼Œä¼šåŒæ—¶è§¦å‘ push å’Œ pull_request äº‹ä»¶
    # - æˆ‘ä»¬åªåœ¨ push äº‹ä»¶æ—¶æ‰§è¡Œï¼Œå¿½ç•¥ pull_request closed äº‹ä»¶ï¼ˆå› ä¸ºä¼šè§¦å‘ pushï¼‰
    # - ä½†ä¿ç•™ pull_request opened/synchronize äº‹ä»¶ï¼ˆç”¨äºæ›´æ–° release PRï¼‰
    if: |
      github.event_name == 'push' ||
      (github.event_name == 'pull_request' && github.event.action != 'closed') ||
      (github.event_name == 'pull_request' && github.event.action == 'closed' && github.event.pull_request.merged == false)
    steps:
      - uses: googleapis/release-please-action@16a9c90856f42705d54a6fda1823352bdc62cf38 # v4.4.0
        id: release
        continue-on-error: true
        with:
          # ä½¿ç”¨é»˜è®¤çš„ GITHUB_TOKEN
          # å¦‚éœ€ä½¿ç”¨ PATï¼Œå¯é…ç½® token: ${{ secrets.RELEASE_PLEASE_TOKEN }}
          config-file: .github/release-please-config.json
          manifest-file: .github/.release-please-manifest.json
          # ç¦ç”¨è‡ªåŠ¨æ·»åŠ æ ‡ç­¾ï¼ˆå¦‚ autorelease: snapshotï¼‰ï¼Œç”±åç»­æ­¥éª¤æ‰‹åŠ¨æ·»åŠ è‡ªå®šä¹‰æ ‡ç­¾
          skip-labeling: true
          # ç¦ç”¨è‡ªåŠ¨åˆ›å»º GitHub Release/Tagï¼Œäº¤ç”± create-tag å·¥ä½œæµå¤„ç†
          # è¿™æ ·å¯ä»¥ä½¿ç”¨ PAT (RELEASE_TOKEN) åˆ›å»º Tagï¼Œä»è€Œè‡ªåŠ¨è§¦å‘ Release æ„å»ºå·¥ä½œæµ
          skip-github-release: true

      - name: Add ğŸš€ release label to PR
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Waiting for PR to be searchable..."
          # ç®€å•çš„é‡è¯•é€»è¾‘ï¼šå°è¯• 5 æ¬¡ï¼Œæ¯æ¬¡é—´éš” 5 ç§’
          for i in {1..5}; do
            # æ˜¾å¼æŒ‡å®š repo ä»¥é¿å…éœ€è¦ checkout
            PR_NUMBER=$(gh pr list --repo ${{ github.repository }} --search "head:release-please--branches--main is:open" --json number --jq '.[0].number')
            
            if [ -n "$PR_NUMBER" ] && [ "$PR_NUMBER" != "null" ]; then
              echo "Found Release PR: #$PR_NUMBER"
              gh pr edit "$PR_NUMBER" --repo ${{ github.repository }} --add-label "ğŸš€ release"
              echo "Added 'ğŸš€ release' label to PR #$PR_NUMBER"
              exit 0
            fi
            
            echo "Attempt $i: No open release PR found yet. Retrying in 5s..."
            sleep 5
          done
          
          echo "Failed to find release PR after retries."
          # ä¸æŠ¥é”™é€€å‡ºï¼Œé¿å…æ ‡è®° workflow ä¸ºå¤±è´¥
          exit 0
