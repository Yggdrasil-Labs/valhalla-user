name: Release Please

on:
  push:
    branches: [ main ]
  pull_request:
    types: [opened, synchronize, closed]
    branches: [ main ]
  workflow_dispatch: {}

permissions:
  contents: write
  pull-requests: write

jobs:
  release-please:
    runs-on: ubuntu-latest
    # é¿å…é‡å¤æ‰§è¡Œï¼š
    # - å½“ PR åˆå¹¶æ—¶ï¼Œä¼šåŒæ—¶è§¦å‘ push å’Œ pull_request äº‹ä»¶
    # - æˆ‘ä»¬åªåœ¨ push äº‹ä»¶æ—¶æ‰§è¡Œï¼Œå¿½ç•¥ pull_request closed äº‹ä»¶ï¼ˆå› ä¸ºä¼šè§¦å‘ pushï¼‰
    # - ä½†ä¿ç•™ pull_request opened/synchronize äº‹ä»¶ï¼ˆç”¨äºæ›´æ–° release PRï¼‰
    if: |
      github.event_name == 'push' ||
      (github.event_name == 'pull_request' && github.event.action != 'closed') ||
      (github.event_name == 'pull_request' && github.event.action == 'closed' && github.event.pull_request.merged == false)
    steps:
      - uses: googleapis/release-please-action@16a9c90856f42705d54a6fda1823352bdc62cf38
        id: release
        continue-on-error: true
        with:
          # ä½¿ç”¨é»˜è®¤çš„ GITHUB_TOKENï¼ˆå·²å¯ç”¨ "Allow GitHub Actions to create and approve pull requests"ï¼‰
          # å¦‚éœ€ä½¿ç”¨ PATï¼Œå¯é…ç½® token: ${{ secrets.RELEASE_PLEASE_TOKEN }}
          config-file: .github/release-please-config.json
          manifest-file: .github/.release-please-manifest.json
          # ç¦ç”¨è‡ªåŠ¨æ·»åŠ æ ‡ç­¾ï¼ˆå¦‚ autorelease: snapshotï¼‰ï¼Œç”±åç»­æ­¥éª¤æ‰‹åŠ¨æ·»åŠ è‡ªå®šä¹‰æ ‡ç­¾
          skip-labeling: true

      - name: Debug release-please outputs
        if: always()
        run: |
          echo "=== Release Please Outputs ==="
          echo "pull_request_number: '${{ steps.release.outputs.pull_request_number }}'"
          echo "version: '${{ steps.release.outputs.version }}'"
          echo "release_created: '${{ steps.release.outputs.release_created }}'"
          echo "outcome: '${{ steps.release.outcome }}'"
          echo "=============================="

      - name: Update revision in Release PR
        if: steps.release.outcome == 'success' || steps.release.outcome == 'failure'
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            // é¦–å…ˆå°è¯•ä» release-please è¾“å‡ºè·å– PR å·å’Œç‰ˆæœ¬
            let prNumber = '${{ steps.release.outputs.pull_request_number }}';
            let version = '${{ steps.release.outputs.version }}';
            
            console.log(`Initial PR number from release-please: ${prNumber || 'empty'}`);
            console.log(`Initial version from release-please: ${version || 'empty'}`);
            
            // å¦‚æœæ²¡æœ‰ä» release-please è·å–åˆ°ï¼Œå°è¯•æŸ¥æ‰¾ç°æœ‰çš„ release PR
            if (!prNumber) {
              console.log('No PR number from release-please, searching for existing release PR...');
              // simple release type ä½¿ç”¨ä¸åŒçš„åˆ†æ”¯æ ¼å¼ï¼Œå°è¯•ä¸¤ç§æ ¼å¼
              let prs = [];
              try {
                const result = await github.rest.pulls.list({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  state: 'open',
                  head: `${context.repo.owner}:release-please--branches--main`,
                  sort: 'created',
                  direction: 'desc',
                  per_page: 1
                });
                prs = result.data;
              } catch (e) {
                // å¦‚æœ simple æ ¼å¼æ‰¾ä¸åˆ°ï¼Œå°è¯• java æ ¼å¼
                const result = await github.rest.pulls.list({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  state: 'open',
                  head: `${context.repo.owner}:release-please--branches--main--components--valhalla-user`,
                  sort: 'created',
                  direction: 'desc',
                  per_page: 1
                });
                prs = result.data;
              }
              
              if (prs.length > 0) {
                prNumber = prs[0].number.toString();
                console.log(`Found existing release PR: #${prNumber}`);
                
                // ä» PR æ ‡é¢˜ä¸­æå–ç‰ˆæœ¬å·ï¼ˆæ”¯æŒå¤šç§æ ¼å¼ï¼‰
                // ä¾‹å¦‚: "chore(main): release midgard-backend-template 1.0.0" æˆ– "release 1.0.0"
                const titleMatch = prs[0].title.match(/(?:release|ç‰ˆæœ¬)\s+(?:valhalla-user\s+)?(\d+\.\d+\.\d+)/i) ||
                                  prs[0].title.match(/(\d+\.\d+\.\d+)/);
                if (titleMatch) {
                  version = titleMatch[1];
                  console.log(`Extracted version from PR title: ${version}`);
                }
                
                // å¦‚æœä»æ ‡é¢˜æå–å¤±è´¥ï¼Œå°è¯•ä» PR åˆ†æ”¯çš„ manifest æ–‡ä»¶è·å–
                if (!version) {
                  try {
                    const { data: manifest } = await github.rest.repos.getContent({
                      owner: context.repo.owner,
                      repo: context.repo.repo,
                      path: '.github/.release-please-manifest.json',
                      ref: prs[0].head.ref  // ä½¿ç”¨ PR åˆ†æ”¯ï¼Œè€Œä¸æ˜¯ main åˆ†æ”¯
                    });
                    
                    const manifestContent = JSON.parse(
                      Buffer.from(manifest.content, 'base64').toString('utf-8')
                    );
                    version = manifestContent['.'] || '';
                    console.log(`Version from PR branch manifest: ${version}`);
                  } catch (error) {
                    console.log('Could not read manifest file from PR branch');
                  }
                }
              }
            }
            
            // å¦‚æœè¿˜æ˜¯æ²¡æœ‰ç‰ˆæœ¬å·ï¼Œå°è¯•ä» main åˆ†æ”¯çš„ manifest æ–‡ä»¶è·å–ï¼ˆæœ€åçš„åå¤‡æ–¹æ¡ˆï¼‰
            if (!version) {
              try {
                const { data: manifest } = await github.rest.repos.getContent({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  path: '.github/.release-please-manifest.json',
                  ref: 'main'
                });
                
                const manifestContent = JSON.parse(
                  Buffer.from(manifest.content, 'base64').toString('utf-8')
                );
                version = manifestContent['.'] || '';
                console.log(`Version from main branch manifest: ${version}`);
                console.log('âš ï¸  Warning: Using version from main branch manifest, which may be outdated');
              } catch (error) {
                console.log('Could not read manifest file from main branch');
              }
            }
            
            if (!prNumber) {
              console.log('No release PR found, skipping revision update');
              return;
            }
            
            if (!version) {
              console.log('No version found, skipping revision update');
              return;
            }
            
            console.log(`Updating revision in PR #${prNumber} to ${version}`);
            
            // è·å– PR ä¿¡æ¯
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: parseInt(prNumber)
            });
            
            // è·å– PR åˆ†æ”¯çš„ pom.xml å†…å®¹
            const { data: pomContent } = await github.rest.repos.getContent({
              owner: context.repo.owner,
              repo: context.repo.repo,
              path: 'pom.xml',
              ref: pr.head.ref
            });
            
            const currentPom = Buffer.from(pomContent.content, 'base64').toString('utf-8');
            
            // æ›´æ–° revisionï¼ˆç§»é™¤ -SNAPSHOT åç¼€ï¼‰
            const releaseVersion = version.replace(/-SNAPSHOT$/, '');
            const updatedPom = currentPom.replace(
              /<revision>[^<]*<\/revision>/,
              `<revision>${releaseVersion}</revision>`
            );
            
            if (updatedPom === currentPom) {
              console.log('No changes needed (revision already updated)');
              return;
            }
            
            console.log(`Current revision in PR: ${currentPom.match(/<revision>([^<]*)<\/revision>/)?.[1] || 'not found'}`);
            console.log(`Updating to: ${releaseVersion}`);
            
            // æ›´æ–°æ–‡ä»¶
            await github.rest.repos.createOrUpdateFileContents({
              owner: context.repo.owner,
              repo: context.repo.repo,
              path: 'pom.xml',
              message: `chore: update revision to ${releaseVersion} for release`,
              content: Buffer.from(updatedPom).toString('base64'),
              sha: pomContent.sha,
              branch: pr.head.ref
            });
            
            console.log(`âœ“ Updated revision to ${releaseVersion} in PR #${prNumber}`);

      - name: Check for existing release PR
        if: steps.release.outcome == 'failure'
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            // simple release type ä½¿ç”¨ä¸åŒçš„åˆ†æ”¯æ ¼å¼ï¼Œå°è¯•ä¸¤ç§æ ¼å¼
            let prs = [];
            try {
              const result = await github.rest.pulls.list({
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'open',
                head: `${context.repo.owner}:release-please--branches--main`,
                sort: 'created',
                direction: 'desc',
                per_page: 1
              });
              prs = result.data;
            } catch (e) {
              // å¦‚æœ simple æ ¼å¼æ‰¾ä¸åˆ°ï¼Œå°è¯• java æ ¼å¼
              const result = await github.rest.pulls.list({
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'open',
                head: `${context.repo.owner}:release-please--branches--main--components--midgard-backend-template`,
                sort: 'created',
                direction: 'desc',
                per_page: 1
              });
              prs = result.data;
            }
            
            if (prs.length > 0) {
              console.log(`â„¹ï¸  Release PR already exists: #${prs[0].number}`);
              console.log(`   PR URL: ${prs[0].html_url}`);
              console.log(`   This is normal - release-please will update the existing PR when new changes are pushed.`);
              console.log(`   The workflow will continue despite this error.`);
            } else {
              console.log('âš ï¸  No existing release PR found, but release-please failed.');
              console.log('   This might be a temporary issue. Please check the error message above.');
            }

      - name: Add ğŸš€ release label to PR
        if: ${{ steps.release.outputs.pull_request_number != '' }}
        uses: actions-ecosystem/action-add-labels@18f1af5e3544586314bbe15c0273249c770b2daf
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          number: ${{ steps.release.outputs.pull_request_number }}
          labels: |
            ğŸš€ release
      
      - name: Find and label release PR (fallback)
        if: ${{ steps.release.outputs.pull_request_number == '' && steps.release.outcome == 'success' }}
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            // simple release type ä½¿ç”¨ä¸åŒçš„åˆ†æ”¯æ ¼å¼ï¼Œå°è¯•ä¸¤ç§æ ¼å¼
            let prs = [];
            try {
              const result = await github.rest.pulls.list({
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'open',
                head: `${context.repo.owner}:release-please--branches--main`,
                sort: 'created',
                direction: 'desc',
                per_page: 1
              });
              prs = result.data;
            } catch (e) {
              // å¦‚æœ simple æ ¼å¼æ‰¾ä¸åˆ°ï¼Œå°è¯• java æ ¼å¼
              const result = await github.rest.pulls.list({
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'open',
                head: `${context.repo.owner}:release-please--branches--main--components--midgard-backend-template`,
                sort: 'created',
                direction: 'desc',
                per_page: 1
              });
              prs = result.data;
            }
            
            if (prs.length > 0) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prs[0].number,
                labels: ['ğŸš€ release']
              });
              console.log(`Added ğŸš€ release label to PR #${prs[0].number}`);
            }

      - name: Note about tag creation
        if: github.event_name == 'pull_request' && github.event.pull_request.merged == true
        run: |
          echo "â„¹ï¸  Release PR merged. Tag creation will be handled by the 'Create Tag' workflow."
          echo "   The 'Create Tag' workflow will be triggered automatically after this workflow completes."

