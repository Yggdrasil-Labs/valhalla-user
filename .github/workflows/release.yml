name: Release

on:
  push:
    tags:
      - 'v*'

env:
  MAVEN_OPTS: -Xmx1024m -XX:+UseG1GC
  JAVA_VERSION: '17'

jobs:
  build-verify:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8
        with:
          # push äº‹ä»¶æ—¶ï¼Œä½¿ç”¨ github.refï¼ˆå·²ç»æ˜¯ tag refï¼‰
          ref: ${{ github.ref }}
          fetch-depth: 0

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@f2beeb24e141e01a676f977032f5a29d81c9e27e
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'maven'

      - name: Make Maven Wrapper executable
        run: |
          if [ -f "mvnw" ]; then
            chmod +x mvnw
            ls -la mvnw
            echo "Maven Wrapper made executable"
          else
            echo "Error: mvnw not found"
            exit 1
          fi

      - name: Verify build (format check + compile)
        run: ./mvnw -B -U spotless:check clean package -DskipTests

  build-release:
    runs-on: ubuntu-latest
    needs: [ build-verify ]
    permissions:
      contents: read
      packages: read
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8
        with:
          # push äº‹ä»¶æ—¶ï¼Œä½¿ç”¨ github.refï¼ˆå·²ç»æ˜¯ tag refï¼‰
          ref: ${{ github.ref }}
          fetch-depth: 0

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@f2beeb24e141e01a676f977032f5a29d81c9e27e
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'maven'

      - name: Make Maven Wrapper executable
        run: |
          if [ -f "mvnw" ]; then
            chmod +x mvnw
            ls -la mvnw
            echo "Maven Wrapper made executable"
          else
            echo "Error: mvnw not found"
            exit 1
          fi

      - name: Get version from tag
        id: get_version
        run: |
          # ä» tag è·å–ç‰ˆæœ¬å·
          TAG_NAME=${GITHUB_REF#refs/tags/}
          VERSION=${TAG_NAME#v}  # ç§»é™¤ 'v' å‰ç¼€
          echo "Tag: $TAG_NAME"
          echo "Version: $VERSION"
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Update version in pom.xml for release
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"
          
          if [ -z "$VERSION" ]; then
            echo "Error: Version is empty"
            exit 1
          fi
          
          echo "Updating pom.xml revision to: $VERSION"
          
          # ä½¿ç”¨ sed æ›´æ–° pom.xml ä¸­çš„ç‰ˆæœ¬å·ï¼ˆGitHub Actions runner æ˜¯ Linuxï¼‰
          sed -i "s|<revision>[^<]*</revision>|<revision>$VERSION</revision>|g" pom.xml
          
          echo "Updated pom.xml:"
          grep -A 2 -B 2 "<revision>" pom.xml
          
          # éªŒè¯æ‰€æœ‰å­æ¨¡å—çš„ pom.xml ä¹Ÿä¼šä½¿ç”¨æ­£ç¡®çš„ç‰ˆæœ¬å·
          echo ""
          echo "Verifying version in submodules..."
          find . -name "pom.xml" -type f | head -5 | while read pom; do
            if grep -q "<version>\${revision}</version>" "$pom" 2>/dev/null; then
              echo "  âœ“ $pom uses \${revision}"
            fi
          done

      - name: Configure Maven for GitHub Packages
        run: |
          mkdir -p ~/.m2
          cat > ~/.m2/settings.xml << 'EOF'
          <settings xmlns="http://maven.apache.org/SETTINGS/1.0.0"
                    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                    xsi:schemaLocation="http://maven.apache.org/SETTINGS/1.0.0 https://maven.apache.org/xsd/settings-1.0.0.xsd">
            <servers>
              <server>
                <id>github</id>
                <username>${env.GITHUB_ACTOR}</username>
                <password>${env.GITHUB_TOKEN}</password>
              </server>
            </servers>
          </settings>
          EOF
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Flatten POM files before deploy
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"
          echo "Executing flatten:flatten to replace \${revision} variables with version: $VERSION"
          ./mvnw -B -U -Drevision=$VERSION flatten:flatten
          echo "Flatten completed. Verifying flattened POMs..."
          find . -name ".flattened-pom.xml" -type f | head -3 | while read pom; do
            echo "Checking: $pom"
            if grep -q "<version>\${revision}</version>" "$pom" 2>/dev/null; then
              echo "  âš ï¸  WARNING: $pom still contains \${revision}"
            else
              echo "  âœ“ $pom has been flattened correctly"
            fi
          done

      - name: Build packages (jar files)
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"
          echo "Building packages with version: $VERSION"
          ./mvnw -B -U -DskipTests=true -Drevision=$VERSION \
            package
          echo "Verifying jar files were built..."
          find . -name "*.jar" -path "*/target/*" -not -path "*/original-*" | head -10

  create-github-release:
    runs-on: ubuntu-latest
    needs: [ build-release ]
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8
        with:
          ref: ${{ github.ref }}
          fetch-depth: 0

      - name: Get version from tag
        id: get_version
        run: |
          # ä» tag è·å–ç‰ˆæœ¬
          TAG_NAME=${GITHUB_REF#refs/tags/}
          VERSION=${TAG_NAME#v}  # ç§»é™¤ 'v' å‰ç¼€
          echo "Tag: $TAG_NAME"
          echo "Version: $VERSION"
          echo "tag=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Extract release notes from CHANGELOG
        id: changelog
        run: |
          TAG_NAME="${{ steps.get_version.outputs.tag }}"
          VERSION="${{ steps.get_version.outputs.version }}"
          
          # é»˜è®¤ release notesï¼ˆå¸¦å›¾æ ‡ï¼‰
          DEFAULT_NOTES="## ğŸš€ Release $VERSION
          
          Release $VERSION is now available! ğŸ‰
          
          ğŸ“ See the [changelog](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md) for details."
          
          # æ£€æŸ¥ CHANGELOG.md æ˜¯å¦å­˜åœ¨
          if [ ! -f "CHANGELOG.md" ]; then
            echo "CHANGELOG.md not found, using default release notes"
            RELEASE_NOTES="$DEFAULT_NOTES"
          else
            # release-please ç”Ÿæˆçš„ CHANGELOG æ ¼å¼é€šå¸¸æ˜¯ï¼š
            # ## [1.0.0] - 2024-01-01
            # æˆ–
            # ## 1.0.0 - 2024-01-01
            
            # å°è¯•æå–å¯¹åº”ç‰ˆæœ¬çš„ release notes
            # ä½¿ç”¨ awk æå–ä»ç‰ˆæœ¬æ ‡é¢˜åˆ°ä¸‹ä¸€ä¸ªç‰ˆæœ¬æ ‡é¢˜ï¼ˆæˆ–æ–‡ä»¶ç»“å°¾ï¼‰ä¹‹é—´çš„å†…å®¹
            EXTRACTED=$(awk -v version="$VERSION" '
              BEGIN {
                found=0
                in_section=0
              }
              /^## \[/ || /^## [0-9]/ {
                if (in_section) exit
                # ä½¿ç”¨ index() è¿›è¡Œå­—é¢é‡å­—ç¬¦ä¸²åŒ¹é…ï¼Œé¿å…æ­£åˆ™è¡¨è¾¾å¼å…ƒå­—ç¬¦é—®é¢˜
                # æ£€æŸ¥æ ¼å¼: ## [1.0.0] æˆ– ## 1.0.0
                if (index($0, "[" version "]") > 0 || index($0, "## " version) == 1) {
                  found=1
                  in_section=1
                  print
                  next
                }
              }
              in_section { print }
            ' CHANGELOG.md)
            
            if [ -n "$EXTRACTED" ] && [ ${#EXTRACTED} -gt 10 ]; then
              # åªä¸ºç‰ˆæœ¬æ ‡é¢˜æ·»åŠ ç«ç®­å›¾æ ‡ï¼ˆCHANGELOGå·²ç»åŒ…å«ç« èŠ‚å’Œæ¡ç›®çš„å›¾æ ‡ï¼‰
              CHANGELOG_CONTENT=$(echo "$EXTRACTED" | sed \
                -e 's/^## \[\([^]]*\)\]/## ğŸš€ Release \1/g' \
                -e 's/^## \([0-9][^ ]*\) /## ğŸš€ Release \1 /g' \
                -e 's/BREAKING CHANGE/ğŸ’¥ BREAKING CHANGE/g' \
                -e 's/Breaking Change/ğŸ’¥ Breaking Change/g')
              
              # åˆ†æ­¥éª¤æ„å»º release notesï¼Œæ·»åŠ å‘å¸ƒæ¨ªå¹…å’Œå®‰è£…è¯´æ˜
              RELEASE_NOTES=""
              RELEASE_NOTES="${RELEASE_NOTES}ğŸ‰ **Release ${VERSION} is now available!**"
              RELEASE_NOTES="${RELEASE_NOTES}"$'\n'$'\n'
              RELEASE_NOTES="${RELEASE_NOTES}${CHANGELOG_CONTENT}"
              RELEASE_NOTES="${RELEASE_NOTES}"$'\n'$'\n'
              RELEASE_NOTES="${RELEASE_NOTES}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              RELEASE_NOTES="${RELEASE_NOTES}"$'\n'$'\n'
              RELEASE_NOTES="${RELEASE_NOTES}ğŸ“– [View Full Changelog](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md) | ğŸ“‹ [Documentation](https://github.com/${{ github.repository }}/blob/main/README.md)"
              
              echo "Successfully extracted and enhanced release notes from CHANGELOG.md"
            else
              echo "Could not extract release notes from CHANGELOG.md, using default"
              RELEASE_NOTES="$DEFAULT_NOTES"
            fi
          fi
          
          # ä½¿ç”¨ multiline output
          {
            echo "release_notes<<EOF"
            echo "$RELEASE_NOTES"
            echo "EOF"
          } >> $GITHUB_OUTPUT
          
          echo "Release notes prepared (first 300 chars):"
          echo "$RELEASE_NOTES" | head -c 300
          echo ""

      - name: Create GitHub Release
        uses: softprops/action-gh-release@de2c0eb89ae2a093876385947365aca7b0e5f844
        with:
          tag_name: ${{ steps.get_version.outputs.tag }}
          name: Release ${{ steps.get_version.outputs.version }}
          body: ${{ steps.changelog.outputs.release_notes }}
          draft: false
          prerelease: false
          generate_release_notes: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  update-dev-version:
    runs-on: ubuntu-latest
    needs: [ build-release ]
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Get released version from tag
        id: get_version
        run: |
          # ä» tag è·å–ç‰ˆæœ¬
          TAG_NAME=${GITHUB_REF#refs/tags/}
          VERSION=${TAG_NAME#v}  # ç§»é™¤ 'v' å‰ç¼€
          
          # è·å– tag æŒ‡å‘çš„ commit SHA
          TAG_SHA=$(git rev-parse $TAG_NAME^{commit})
          
          echo "Released version: $VERSION"
          echo "Tag: $TAG_NAME"
          echo "Tag commit SHA: $TAG_SHA"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "tag_sha=$TAG_SHA" >> $GITHUB_OUTPUT

      - name: Calculate next development version
        id: next_version
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"
          # ç§»é™¤å¯èƒ½çš„ -SNAPSHOT åç¼€ï¼ˆå¦‚æœæœ‰ï¼‰
          VERSION=${VERSION%-SNAPSHOT}
          
          # è§£æç‰ˆæœ¬å·ï¼šä¸»ç‰ˆæœ¬.æ¬¡ç‰ˆæœ¬.ä¿®è®¢ç‰ˆæœ¬
          IFS='.' read -r MAJOR MINOR PATCH <<< "$VERSION"
          
          # è®¡ç®—ä¸‹ä¸€ä¸ªå¼€å‘ç‰ˆæœ¬ï¼ˆpatch + 1ï¼Œç„¶ååŠ ä¸Š -SNAPSHOTï¼‰
          NEXT_PATCH=$((PATCH + 1))
          NEXT_VERSION="${MAJOR}.${MINOR}.${NEXT_PATCH}-SNAPSHOT"
          
          echo "Current released version: $VERSION"
          echo "Next development version: $NEXT_VERSION"
          echo "next_version=$NEXT_VERSION" >> $GITHUB_OUTPUT

      - name: Checkout main branch
        run: |
          git checkout main
          git pull origin main

      - name: Update version
        run: |
          NEXT_VERSION="${{ steps.next_version.outputs.next_version }}"
          
          # æ›´æ–° pom.xml ä¸­çš„ç‰ˆæœ¬å·
          echo "Updating pom.xml to version: $NEXT_VERSION"
          sed -i.bak "s|<revision>[^<]*</revision>|<revision>$NEXT_VERSION</revision>|g" pom.xml
          rm -f pom.xml.bak
          
          echo "Updated pom.xml content:"
          grep -A 2 -B 2 "<revision>" pom.xml

      - name: Commit and push changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # åœ¨æäº¤å‰æ‹‰å–æœ€æ–°æ›´æ”¹
          echo "Pulling latest changes from main before committing..."
          git pull --rebase origin main || git pull origin main
          
          # æ·»åŠ æ‰€æœ‰æ›´æ”¹çš„æ–‡ä»¶
          git add pom.xml
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹
          if git diff --staged --quiet; then
            echo "No changes to commit (version may already be updated)"
          else
            NEXT_VERSION="${{ steps.next_version.outputs.next_version }}"
            
            # æ„å»ºæäº¤æ¶ˆæ¯
            COMMIT_MSG="chore: bump version to $NEXT_VERSION for next development cycle"
            
            git commit -m "$COMMIT_MSG"
            
            # æ¨é€æ›´æ”¹
            git push origin main
            
            echo "Successfully updated version to $NEXT_VERSION"
          fi
